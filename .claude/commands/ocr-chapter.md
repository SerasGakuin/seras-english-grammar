# OCR章書き起こし

指定した章を書き起こしてMarkdownファイルとして保存する。

## 引数
- $ARGUMENTS: 書籍名 章ID（例: 核心 Part1_01、成川 Part01_01）

## 手順

1. **status.jsonから章情報を取得**
   - `progress/status.json` を読む
   - 指定章のページ範囲・スポットチェック要否を取得

2. **画像準備**
   - `page_mapping` から対象PDFファイルを特定
   - 該当ページの画像が `pdf/images/{書籍名}/` にあるか確認
   - なければ `python scripts/pdf_tools.py to-images` で生成

3. **書き起こし実行**
   - subagent (general-purpose) に以下を渡す:
     - 画像ファイルパス（章の全ページ）
     - 表記ルール（`.rules/notation-rules.md`）
     - 書籍名・章番号（コンテキスト）
     - 出力ファイルパス: `pdf/output/{書籍名}/{章ID}_{章名}.md`
   - **SubAgentは書き起こし完了後、ファイルに直接保存する**
   - **SubAgentは保存したファイルパスのみを返す（Markdown本文は返さない）**

4. **Codexレビュー**
   - `/ocr-review` を実行
   - 結果に応じて分岐:
     - **「問題なし」 + `spot_check_required: false`**:
       → 即座にstatus.json更新、完了
     - **「問題なし」 + `spot_check_required: true`**:
       → スポットチェック実施後、完了
     - **「指摘あり」**:
       → 修正判断（原本確認が必要な場合あり）
       → 修正後、再レビュー（リトライ上限: 2回）

5. **スポットチェック（該当章のみ）**
   - `spot_check_required: true` の章のみ実施
   - 条件:
     - 各書籍の最初の章
     - 5章ごと（5, 10, 15...）
     - 前半/後半の境界をまたぐ章
     - Codexが警告を出した章
   - **目的**: Codex指摘の検証、原本との照合
   - **確認項目**:
     - Codexが指摘した箇所の原本確認
     - 括弧、空白、大文字小文字の正確性
     - ページ区切り位置の適切さ
   - **判断基準**: 原本と一致していれば「維持」、不一致なら「修正」
   - 方法: 章の最初と最後のページ + Codex指摘箇所を確認
   - ログ: `progress/logs/spot_checks/{日付}_{書籍名}_{章ID}.md`

6. **status.json更新**
   - SubAgentが既にファイル保存済み
   - `progress/status.json` の該当章を更新:
     - `status: "completed"`
     - `output_file: "{ファイルパス}"`
     - `review_status: "passed"` or `"flagged"`

## subagentへの指示テンプレート

```
以下の画像ファイルを読み込んで、英語参考書の章をMarkdown形式で書き起こしてください。

書籍: {書籍名}
章: {章ID} {章名}

画像ファイル:
{画像ファイルパスのリスト}

出力ファイル:
{出力ファイルパス}

表記ルール:
{.rules/notation-rules.md の内容}

ルール:
1. 本文、例文、解説を正確に書き起こす
2. 図表は [図表: 説明] の形式で記載
3. ページ番号は各ページの**末尾**に、**文の区切り**で記載
   - 形式: `---` + 改行 + `**p.XX**` + 改行 + `---`
   - 単語や文の途中で分断しない
   - ページ末尾の文が次ページに続く場合は、文を完結させてからページ番号を挿入
4. 原本の表記（空白、括弧、大文字小文字）を忠実に再現
5. 余計な説明は不要、本文のみ出力
6. 書き起こし完了後、指定された出力ファイルに保存する
7. 最後に保存したファイルパスを報告する（Markdown本文は返さない）

出力形式: 保存完了後、ファイルパスのみ報告
```

## エラー時の対応

| エラー | 対応 | リトライ上限 |
|--------|------|-------------|
| 画像が読めない | DPIを上げて再変換（150→200→300） | 3回 |
| subagentタイムアウト | ページ数を半分に減らして再試行 | 2回 |
| Codexがエラー検出 | 修正して再レビュー | 2回 |

リトライ上限超過時は `progress/logs/errors/` にログを記録し、ユーザーに報告。

## 注意事項
- 1章ずつ処理する（複数章を一度に処理しない）
- オーケストレーター自身は画像を読まない（subagentに委譲）
- スポットチェック時のみオーケストレーターが画像を確認
- 新しい表現が出てきたら、表記ルール更新を検討
