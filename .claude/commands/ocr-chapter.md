# OCR章書き起こし

指定した章を書き起こしてMarkdownファイルとして保存する。

## 引数
- $ARGUMENTS: 書籍名 章ID（例: 核心 Part1_01、成川 Part01_01）

## 手順

1. **status.jsonから章情報を取得**
   - `progress/status.json` を読む
   - 指定章のページ範囲・スポットチェック要否を取得

2. **画像準備**
   - `page_mapping` から対象PDFファイルを特定
   - 該当ページの画像が `pdf/images/{書籍名}/` にあるか確認
   - なければ `python scripts/pdf_tools.py to-images` で生成

3. **書き起こし実行**
   - subagent (general-purpose) に以下を渡す:
     - 画像ファイルパス（章の全ページ）
     - 表記ルール（`.rules/notation-rules.md`）
     - 書籍名・章番号（コンテキスト）

4. **Codexレビュー**
   - `/ocr-review` を実行
   - 問題があれば修正（リトライ上限: 2回）

5. **スポットチェック判定**
   - `spot_check_required: true` の章のみ実施
   - 条件:
     - 各書籍の最初の章
     - 5章ごと（5, 10, 15...）
     - 前半/後半の境界をまたぐ章
     - Codexが警告を出した章
   - 方法: 章の最初と最後のページを確認
   - ログ: `progress/logs/spot_checks/{日付}_{書籍名}_{章ID}.md`

6. **保存**
   - `pdf/output/{書籍名}/{Part番号}_{章番号}_{章名}.md` に保存
   - `progress/status.json` の該当章を更新:
     - `status: "completed"`
     - `output_file: "{ファイルパス}"`
     - `review_status: "passed"` or `"flagged"`

## subagentへの指示テンプレート

```
以下の画像ファイルを読み込んで、英語参考書の章をMarkdown形式で書き起こしてください。

書籍: {書籍名}
章: {章ID} {章名}

画像ファイル:
{画像ファイルパスのリスト}

表記ルール:
{.rules/notation-rules.md の内容}

ルール:
1. 本文、例文、解説を正確に書き起こす
2. 図表は [図表: 説明] の形式で記載
3. ページ番号は各ページの区切りとして記載
4. 余計な説明は不要、本文のみ出力

出力形式: Markdownテキストのみ
```

## エラー時の対応

| エラー | 対応 | リトライ上限 |
|--------|------|-------------|
| 画像が読めない | DPIを上げて再変換（150→200→300） | 3回 |
| subagentタイムアウト | ページ数を半分に減らして再試行 | 2回 |
| Codexがエラー検出 | 修正して再レビュー | 2回 |

リトライ上限超過時は `progress/logs/errors/` にログを記録し、ユーザーに報告。

## 注意事項
- 1章ずつ処理する（複数章を一度に処理しない）
- オーケストレーター自身は画像を読まない（subagentに委譲）
- スポットチェック時のみオーケストレーターが画像を確認
- 新しい表現が出てきたら、表記ルール更新を検討
