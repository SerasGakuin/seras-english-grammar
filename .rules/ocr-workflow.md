# OCRワークフロー ルール定義

## 概要

英語参考書のPDFを文字データ（Markdown）に変換するワークフロー。
複数のLLMを使い分け、品質と効率を両立する。

---

## 役割分担

| 役割 | 担当 | 責務 |
|------|------|------|
| **オーケストレーター** | Claude Code (メイン) | 全体管理、進捗追跡、品質判断 |
| **書き起こし** | Claude subagent | 画像→Markdown変換 |
| **レビュー** | Codex CLI | 誤字脱字、構造チェック |
| **前処理** | Python (pdf_tools.py) | PDF回転、画像化 |

---

## ワークフロー手順

### Phase 1: 前処理
1. PDFのページ数・サイズを確認
2. 全ページを左90度回転
3. 画像に変換（DPI: 150）
4. `pdf/images/{書籍名}/` に保存

### Phase 2: 目次書き起こし
1. 目次ページの範囲を特定（ユーザーに確認）
2. **subagent** に画像を渡して書き起こし
3. **Codex** でレビュー
4. 問題があれば修正、なければ次へ
5. `pdf/output/{書籍名}/00_目次.md` に保存

### Phase 3: 章ごとの書き起こし
1. 目次からページ範囲を決定
2. 章ごとに **subagent** で書き起こし
3. 章ごとに **Codex** でレビュー
4. `pdf/output/{書籍名}/{章番号}_{章名}.md` に保存
5. `progress/status.json` を更新

### Phase 4: 最終確認
1. 全章の完了を確認
2. ユーザーに最終レビューを依頼
3. 完了マークを付ける

---

## 進捗管理

`progress/status.json` で管理：

```json
{
  "books": {
    "核心": {
      "status": "in_progress",
      "total_chapters": 21,
      "completed_chapters": 5,
      "current_chapter": 6,
      "last_updated": "2026-02-01T20:00:00"
    }
  }
}
```

---

## 品質基準

### 書き起こし品質
- [ ] ページ番号が正確
- [ ] 階層構造が維持されている
- [ ] 日本語・英語の文字化けなし
- [ ] 特殊記号（〈〉、→、etc.）が正しく表現されている

### レビュー観点（Codex）
1. 誤字脱字
2. ページ番号の連続性（飛び、重複）
3. 構造の一貫性（見出しレベル、表記ゆれ）

---

## コンテキスト保護ルール

1. **オーケストレーターは実作業をしない**
   - 画像の読み込み → subagent
   - テキストのレビュー → Codex

2. **1章ずつ処理する**
   - 大量のテキストを一度に扱わない
   - 章ごとに完結させる

3. **状態はファイルに保存**
   - 進捗は `progress/status.json`
   - 中間成果物は `pdf/output/` に即保存

4. **中断・再開を前提に設計**
   - どこで止まっても再開できる
   - 「次に何をすべきか」が明確

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| 画像が読めない | DPIを上げて再変換 |
| subagentがタイムアウト | ページ数を減らして再試行 |
| Codexがエラーを検出 | Claudeが修正して再レビュー |
| 原本と大きく異なる | ユーザーに確認 |

---

## 対象書籍

| 書籍名 | ファイル構成 | ステータス |
|--------|-------------|-----------|
| 核心 | 前半 + 後半 | 目次完了 |
| 成川 | 前半 + 後半 + 別冊 | 目次完了 |
| スクランブル | 前半 + 後半 | 未着手 |
| 肘井 | 本体 + 別冊 | 未着手 |
| 入門英文 | 1ファイル | 未着手 |
