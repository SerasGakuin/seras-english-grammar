# OCRワークフロー ルール定義

## 概要

英語参考書のPDFを文字データ（Markdown）に変換するワークフロー。
複数のLLMを使い分け、品質と効率を両立する。

> **Note**: プロジェクト概要・ディレクトリ構造・利用可能Skillsは `CLAUDE.md` を参照。
> このファイルはワークフロー詳細と実践Tipsを記載。

---

## 役割分担

詳細は `CLAUDE.md` の「役割分担」セクションを参照。

**最重要ルール**: オーケストレーターは画像を直接読まない（subagentに委譲）。スポットチェック時のみ例外。

---

## ワークフロー手順

### Phase 1: 前処理
1. `python scripts/pdf_tools.py info --all` でPDF情報を確認
2. `python scripts/pdf_tools.py page-map {書籍名}` でページマッピングを確認
3. 画像に変換: `python scripts/pdf_tools.py to-images <pdf> <output_dir> --dpi 150`
4. 必要に応じて章ごとに分割: `python scripts/pdf_tools.py split <pdf> --ranges "..." -o <dir>`

### Phase 2: 目次書き起こし
1. 目次ページの範囲を特定（ユーザーに確認）
2. **subagent** に画像を渡して書き起こし
3. **Codex** でレビュー
4. 問題があれば修正、なければ次へ
5. `pdf/output/{書籍名}/00_目次.md` に保存
6. `python scripts/extract_chapters.py <目次.md>` で章情報を抽出
7. `python scripts/migrate_status.py` でstatus.jsonを更新

### Phase 3: 章ごとの書き起こし
1. `status.json` から章のページ範囲を取得
2. 章ごとに **subagent** で書き起こし
3. 章ごとに **Codex** でレビュー
4. **スポットチェック** が必要な場合は実施
5. `pdf/output/{書籍名}/{Part番号}_{章番号}_{章名}.md` に保存
6. `progress/status.json` を更新

### Phase 4: 最終確認
1. 全章の完了を確認
2. ユーザーに最終レビューを依頼
3. 完了マークを付ける

---

## スポットチェック（統一ルール）

以下のいずれかに該当する章は、オーケストレーターがサンプルページで原本照合を行う：

1. **各書籍の最初の章** - 表記スタイルの確認
2. **5章ごと（5, 10, 15, ...）** - 継続的な品質確認
3. **前半/後半の境界をまたぐ章** - ページマッピングの検証
4. **Codexが警告を出した章** - 問題の深堀り

### スポットチェック方法
- 章の最初と最後のページのみ確認（全ページは不要）
- 見出し、ページ番号、図表参照の一致を確認
- 問題があれば `progress/logs/spot_checks/` にログを記録

---

## 進捗管理

`progress/status.json` (v2.0) で管理：

```json
{
  "version": "2.0",
  "config": {
    "image_naming": "page_{:03d}.png",
    "dpi": 150,
    "spot_check_interval": 5,
    "max_retry": {...}
  },
  "books": {
    "核心": {
      "status": "toc_completed",
      "files": {"main": [...], "supplement": [...]},
      "page_mapping": {...},
      "chapters": [
        {
          "id": "Part1_01",
          "title": "冠詞",
          "book_pages": {"start": 10, "end": 16},
          "status": "pending",
          "spot_check_required": true
        }
      ]
    }
  }
}
```

---

## 品質基準

### 書き起こし品質
- [ ] ページ番号が正確
- [ ] 階層構造が維持されている
- [ ] 日本語・英語の文字化けなし
- [ ] 特殊記号（〈〉、→、etc.）が正しく表現されている

### レビュー観点（Codex）
1. 誤字脱字
2. ページ番号の連続性（飛び、重複）
3. 構造の一貫性（見出しレベル、表記ゆれ）

---

## コンテキスト保護ルール

1. **オーケストレーターは実作業をしない**
   - 画像の読み込み → subagent
   - テキストのレビュー → Codex

2. **1章ずつ処理する**
   - 大量のテキストを一度に扱わない
   - 章ごとに完結させる

3. **状態はファイルに保存**
   - 進捗は `progress/status.json`
   - 中間成果物は `pdf/output/` に即保存
   - レビューログは `progress/logs/` に記録

4. **中断・再開を前提に設計**
   - どこで止まっても再開できる
   - 「次に何をすべきか」が明確

---

## エラーハンドリング

| 状況 | 対応 | リトライ上限 |
|------|------|-------------|
| 画像が読めない | DPIを上げて再変換（150→200→300） | 3回 |
| subagentがタイムアウト | ページ数を半分に減らして再試行 | 2回 |
| Codexがエラーを検出 | Claudeが修正して再レビュー | 2回 |
| 原本と大きく異なる | ユーザーに確認 | - |

リトライ上限を超えた場合は `progress/logs/errors/` にログを記録し、ユーザーに報告。

---

## 別冊の扱い

- 別冊は本体とは**独立したエントリー**で管理
- ディレクトリ: `pdf/images/{書籍名}_別冊/`, `pdf/output/{書籍名}_別冊/`
- status.jsonでは `books.{書籍名}_別冊` として独立管理（例: `成川_別冊`, `肘井_別冊`）
- 本体と別冊の相互参照は行わない（独立処理）

---

## 命名規則

詳細は `CLAUDE.md` の「命名規則」セクションを参照。

---

## 対象書籍

詳細は `CLAUDE.md` の「対象書籍」セクションを参照。
（書籍リストはstatus.jsonと`CLAUDE.md`で一元管理）

---

## 実践Tips（核心全21章の経験から）

### 1. ページ境界での文の分断禁止

**最重要ルール**: ページマーカーは必ず文の区切りに配置する。

```markdown
❌ 悪い例:
これが面倒な

---
**p.241**
---

わけです。

✅ 良い例:
これが面倒なわけです。

---
**p.241**
---
```

SubAgentへの指示に明示的に含めること。

### 2. Codex指摘の検証プロセス

Codexは誤検出することがある。特に以下の指摘は必ず検証:

| 指摘タイプ | 検証方法 | 誤検出頻度 |
|-----------|----------|-----------|
| ページ番号欠落 | `grep "**p.XXX**" {file}` | 高 |
| 括弧の不一致 | 原本画像で確認 | 中 |
| 表記ゆれ | 原本が権威、Codexは参考 | 高 |
| 文法的誤り | 原本通りなら維持 | 中 |

**原則**: 原本が常に正しい。Codexの提案が原本と異なれば、原本を維持。

### 3. 長い章での注意点

31ページの関係詞章（Part4_21）で発生した問題:

- **コンテンツ重複**: ページ境界付近で同じ内容が2回出力されることがある
- **対策**: Codexが「重複記述」を検出したら、原本を確認して正しい方を残す

### 4. よくある書き起こしエラー

| エラータイプ | 例 | 対処 |
|-------------|-----|------|
| Unicode合成文字 | `Don̸'t` → `Don't` | 文字コード確認 |
| 括弧の欠落 | `セット）` → `（セット）` | 原本で開き括弧確認 |
| 選択肢番号ずれ | `② open` → `③ open` | 原本の番号確認 |
| 見出しレベル | `## ` → `### ` | 原本の階層構造確認 |

### 5. 効率的なバッチ処理

```
推奨フロー（1章あたり）:
1. SubAgent書き起こし: 1-3分
2. Codexレビュー: 30秒-1分
3. 修正（必要時）: 1-2分
4. スポットチェック（該当章のみ）: 2-3分
5. status.json更新: 即時

→ 1章あたり平均5分、スポットチェック対象は8分
→ 21章で約2時間（休憩含む）
```

### 6. スポットチェックの実施記録

スポットチェック対象章では必ずログを残す:

```
progress/logs/spot_checks/{日付}_{書籍名}_{章ID}.md
```

ログに含める内容:
- Codex指摘事項と検証結果
- 原本との照合結果（最初と最後のページ）
- 修正有無と判断理由

### 7. コミットのタイミング

- **推奨**: Part単位（Part1完了、Part2完了...）でコミット
- **理由**: 中断時の再開が容易、差分が見やすい
- **コミットメッセージ例**: `feat: 核心 Part3（5章）のOCR書き起こしを完了`
